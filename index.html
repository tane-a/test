<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SVG Coloring Book Plugin</title>
    <link rel="stylesheet" href="https://codepen.io/MacEvelly/pen/iJGCw.css" />
    <style>
      .holder {
        width: 900px;
        margin: 0 auto;
      }

      .held {
        position: relative;
      }

      .button {
        display: inline-block;
        width: 150px;
        padding: 10px;
        text-align: center;
        text-decoration: none;
        margin: 5px;
      }

      #ActivityDIV {
        display: flex;
        flex-direction: row;
        align-items: flex-start;
      }

      #ActivityDIV .penHolder {
        position: absolute;
        top: 0;
        right: 0;
        list-style-type: none;
        display: flex;
        flex-direction: column;
        padding: 10px;
        width: 80px;
        background-color: #fff;
        border-radius: 10px;
        color: #000;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.5);
        max-height: 600px;
        overflow-y: auto;
      }

      #ActivityDIV .penHolder .colorHolder {
        width: 60px;
        height: 60px;
        margin: 5px auto;
        cursor: pointer;
        border-radius: 5px;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.5);
        background-size: cover;
        background-image: url("pen.png");
      }

      #ActivityDIV .penHolder li:not(.colorHolder) {
        width: 60px;
        height: 60px;
        margin: 5px auto;
        cursor: pointer;
        border-radius: 5px;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.5);
        background-size: cover;
        background-image: url("pen.png");
      }

      #ActivityDIV .penHolder li.active {
        animation: wiggle 0.3s ease;
      }

      @keyframes wiggle {
        0% {
          transform: rotate(0deg);
        }
        25% {
          transform: rotate(5deg);
        }
        75% {
          transform: rotate(-5deg);
        }
        100% {
          transform: rotate(0deg);
        }
      }

      #ActivityDIV svg {
        width: 700px;
        max-height: 500px;
        display: block;
        object-fit: contain;
      }

      #ActivityDIV svg path {
        cursor: pointer;
      }

      .buttons {
        margin-top: 10px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="holder">
      <h1 class="myTitle">SVG Coloring Book</h1>
      <div class="held" id="ActivityDIV"></div>
      <div class="held buttons">
        <input type="color" id="customColor" title="カスタムカラーを選択" />
        <a id="btnRandom" class="button gray" role="button">ランダムカラー</a>
        <a id="btnClear" class="button gray" role="button">クリア</a>
        <a id="btnDownloadSVG" class="button gray" role="button"
          >SVGをダウンロード</a
        >
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/16327/DrawSVGPlugin.js?r=11"></script>
    <script>
      (function ($) {
        console.clear();
        console.log("svgColor");

        var mainHolder, colorHolder;
        var btnRandom, btnClear, btnDownloadSVG, btnDownloadPNG;
        var svgObject, svgOutline, svgColor;
        var fillSpeed = 0.15;
        var chosenColor = "#FFFFFF";
        var colors = [
          "#FFFFFF",
          "#8E53A1",
          "#6ABD46",
          "#71CCDC",
          "#F7ED45",
          "#F7DAAF",
          "#EC2527",
          "#F16824",
          "#CECCCC",
          "#5A499E",
          "#06753D",
          "#024259",
          "#FDD209",
          "#7D4829",
          "#931B1E",
        ];
        var colorNames = {
          "#FFFFFF": "白",
          "#8E53A1": "紫",
          "#6ABD46": "緑",
          "#71CCDC": "水色",
          "#F7ED45": "黄色",
          "#F7DAAF": "ベージュ",
          "#EC2527": "赤",
          "#F16824": "オレンジ",
          "#CECCCC": "グレー",
          "#5A499E": "濃紫",
          "#06753D": "深緑",
          "#024259": "紺",
          "#FDD209": "金",
          "#7D4829": "茶",
          "#931B1E": "深赤",
        };

        // RGBを16進数カラーコードに変換
        function rgbToHex(r, g, b) {
          return (
            "#" +
            ((1 << 24) + (r << 16) + (g << 8) + b)
              .toString(16)
              .slice(1)
              .toUpperCase()
          );
        }

        function swatchClick() {
          chosenColor = $(this).data("color");
          console.log(chosenColor);
          TweenMax.to(colorHolder, fillSpeed, {
            backgroundColor: chosenColor,
            backgroundImage: "url('pen.png')",
            backgroundSize: "cover",
          });
          $(colorHolder).attr(
            "aria-label",
            "現在の色: " + (colorNames[chosenColor] || chosenColor)
          );
          $(".penHolder li").removeClass("active");
          $(this).addClass("active");
        }

        function colorMe() {
          TweenMax.to(this, fillSpeed, { fill: chosenColor });
        }

        function colorRollover(e) {
          var rollover = e.type == "mouseenter" ? { scale: 1.2 } : { scale: 1 };
          TweenMax.to($(this), 0.05, rollover);
        }

        function svgRandom() {
          $(svgColor).each(function () {
            var randomNum = Math.floor(Math.random() * colors.length);
            TweenMax.to(this, fillSpeed, { fill: colors[randomNum] });
          });
        }

        function svgClear() {
          $(svgColor).each(function () {
            TweenMax.to(this, fillSpeed, { fill: "#FFF" });
          });
        }

        function svgDownloadSVG() {
          var svgInfo = $("<div/>").append($(svgObject).clone()).html();
          $(this).attr({
            href: "data:image/svg+xml;utf8," + svgInfo,
            download: "coloringBook.svg",
            target: "_blank",
          });
        }

        function svgDownloadPNG() {
          // Future expansion: Look at https://bl.ocks.org/biovisualize/8187844
        }

        $.fn.makeSwatches = function () {
          var penHolder = $("<ol/>", { class: "penHolder" }).appendTo(this);
          colorHolder = $("<li/>", {
            class: "colorHolder",
            title: "現在の色",
            tabindex: 0,
          })
            .css({
              "background-color": chosenColor,
              "background-image": "url('pen.png')",
              "background-size": "cover",
            })
            .appendTo(penHolder);

          $.each(colors, function (index, color) {
            var pen = $("<li/>", { tabindex: 0 }).appendTo(penHolder);
            $(pen).css({
              "background-color": color,
              "background-image": "url('pen.png')",
              "background-size": "cover",
            });
            $(pen).data("color", color);
            $(pen).attr("title", colorNames[color] || color);
            $(pen).attr("aria-label", "色: " + (colorNames[color] || color));
            $(pen).on("click", swatchClick);
            $(pen).on("mouseenter mouseleave", colorRollover);
            $(pen).on("keydown", function (e) {
              if (e.key === "Enter" || e.key === " ") {
                $(this).trigger("click");
              }
            });
          });
        };

        $.fn.makeSVGcolor = function (svgURL, fallbackURL) {
          mainHolder = this;
          fetch(svgURL, { mode: "cors" })
            .then((response) => {
              if (!response.ok) {
                throw new Error("CORS or network error: " + response.status);
              }
              return response.text();
            })
            .then((data) => {
              $(mainHolder).html(data);
              svgObject = $("svg", mainHolder);
              svgColor = $(
                "path[fill], path:not([stroke]), rect:not([stroke]), circle:not([stroke])",
                svgObject
              );
              svgOutline = $(
                "path[stroke], rect[stroke], circle[stroke]",
                svgObject
              );
              $(svgColor).each(function () {
                if (!$(this).attr("fill")) {
                  $(this).attr("fill", "#FFF");
                }
              });
              $(svgColor)
                .on("click", colorMe)
                .attr("aria-label", "ドラえもんの部品に色を塗る");
              $(mainHolder).makeSwatches();
              $(".penHolder").addClass("gray");
              // ズーム機能
              $(svgObject).on("wheel", function (e) {
                var scale = e.originalEvent.deltaY > 0 ? 0.9 : 1.1;
                TweenMax.to(this, 0.3, {
                  scale: scale,
                  transformOrigin: "center",
                });
              });
            })
            .catch((error) => {
              console.error("SVG loading failed:", error);
              alert(
                "SVGの読み込みに失敗しました。フォールバック画像を試します。"
              );
              if (fallbackURL) {
                $(mainHolder).load(
                  fallbackURL,
                  function (response, status, xhr) {
                    if (status === "error") {
                      console.error(
                        "Fallback SVG loading failed: " + xhr.status
                      );
                      alert("フォールバックSVGの読み込みにも失敗しました。");
                      return;
                    }
                    svgObject = $("svg", mainHolder);
                    svgColor = $(
                      "path[fill], path:not([stroke]), rect:not([stroke]), circle:not([stroke])",
                      svgObject
                    );
                    svgOutline = $(
                      "path[stroke], rect[stroke], circle[stroke]",
                      svgObject
                    );
                    $(svgColor).each(function () {
                      if (!$(this).attr("fill")) {
                        $(this).attr("fill", "#FFF");
                      }
                    });
                    $(svgColor)
                      .on("click", colorMe)
                      .attr("aria-label", "ドラえもんの部品に色を塗る");
                    $(mainHolder).makeSwatches();
                    $(".penHolder").addClass("gray");
                    $(svgObject).on("wheel", function (e) {
                      var scale = e.originalEvent.deltaY > 0 ? 0.9 : 1.1;
                      TweenMax.to(this, 0.3, {
                        scale: scale,
                        transformOrigin: "center",
                      });
                    });
                  }
                );
              }
            });
        };

        $.fn.btnRandom = function () {
          btnRandom = this;
          $(btnRandom).on("click", svgRandom);
        };

        $.fn.btnClear = function () {
          btnClear = this;
          $(btnClear).on("click", svgClear);
        };

        $.fn.btnDownload = function (type) {
          if (type == "PNG") {
            btnDownloadPNG = this;
            $(this).on("mouseenter", svgDownloadPNG);
          } else {
            btnDownloadSVG = this;
            $(this).on("mouseenter", svgDownloadSVG);
          }
        };

        // カスタムカラー入力
        $("#customColor").on("change", function () {
          chosenColor = $(this).val();
          TweenMax.to(colorHolder, fillSpeed, {
            backgroundColor: chosenColor,
            backgroundImage: "url('pen.png')",
            backgroundSize: "cover",
          });
          $(colorHolder).attr("aria-label", "現在の色: " + chosenColor);
          $(".penHolder li").removeClass("active");
        });
      })(jQuery);

      // GitHub Pagesのdoraemon.svgを指定
      $("#ActivityDIV").makeSVGcolor(
        "https://tane-a.github.io/test/doraemon.svg",
        "./car.svg"
      );
      $("#btnRandom").btnRandom();
      $("#btnClear").btnClear();
      $("#btnDownloadSVG").btnDownload();
    </script>
  </body>
</html>
